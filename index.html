<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Brochure Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header img {
      height: 70px;
      margin-bottom: 10px;
    }
    h1 {
      margin: 0;
      font-size: 26px;
      color: #111;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 18px;
      font-size: 15px;
      cursor: pointer;
      margin: 10px 0;
      transition: background 0.2s;
    }
    .btn:hover { background: #0056b3; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #007bff;
      color: white;
      text-transform: uppercase;
      font-size: 13px;
    }
    tr:hover td { background: #f1f7ff; }
    #modal {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
    }
    #modalContent {
      background:#fff;
      margin:10% auto;
      padding:20px;
      width:350px;
      border-radius:8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    input, textarea {
      width: 100%;
      margin: 5px 0 15px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    a { color: #007bff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" id="siteLogo">
    <h1 id="siteName"></h1>
    <p id="sitePhone"></p>
    <p id="siteAddress"></p>
  </header>

  <button class="btn" onclick="openModal()">Create Brochure</button>
  <div id="inventory">Loading inventory...</div>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h3>Create Brochure</h3>
      <label>Client Name:</label>
      <input type="text" id="clientName">
      <label>Notes:</label>
      <textarea id="clientNotes" rows="4"></textarea>
      <button class="btn" onclick="generatePDF()">Generate PDF</button>
      <button class="btn" style="background:#6c757d" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ‚úÖ CONFIG SECTION (edit here only)
    const CONFIG = {
      galleryName: "World Class Piano Gallery",
      phone: "(555) 123-4567",
      address: "123 Main Street, Dawsonville, GA 30534",
      footerNote: "Delivery is FREE within 1000 miles and includes complimentary tuning on arrival.",
      logoPath: "logo.png"
    };

    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let inventoryData = [];
    let selectedItems = [];
    let logoBase64 = null;

    // üîπ Setup site header
    document.getElementById("siteName").innerText = CONFIG.galleryName;
    document.getElementById("sitePhone").innerText = "Call " + CONFIG.phone + " to order";
    document.getElementById("siteAddress").innerText = CONFIG.address;

    // üîπ Convert logo.png to Base64 for PDF embedding
    async function loadLogo() {
      const response = await fetch(CONFIG.logoPath);
      const blob = await response.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // üîπ Load Piano Inventory
    async function loadInventory() {
      try {
        const querySnapshot = await getDocs(collection(db, "pianos"));
        inventoryData = querySnapshot.docs.map(doc => doc.data());
        renderTable();
      } catch (err) {
        document.getElementById("inventory").innerHTML =
          "<p>‚ùå Could not load inventory. Check Firestore rules.</p>";
        console.error("Firestore error:", err);
      }
    }

    function renderTable() {
      const container = document.getElementById("inventory");
      if (inventoryData.length === 0) {
        container.innerHTML = "<p>No listings found.</p>";
        return;
      }

      let html = "<table><tr><th>Select</th><th>Brand</th><th>Model</th><th>Year</th><th>Serial</th><th>Color</th><th>Length</th><th>Price</th><th>Photo</th></tr>";
      inventoryData.forEach((item, i) => {
        html += `<tr>
          <td><input type="checkbox" onchange="toggleItem(${i}, this.checked)"></td>
          <td>${item.brand || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.year || ""}</td>
          <td>${item.serial || ""}</td>
          <td>${item.color || ""}</td>
          <td>${item.length || ""}</td>
          <td>${item.price || ""}</td>
          <td>${item.photo ? `<a href="${item.photo}" target="_blank">View</a>` : ""}</td>
        </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }

    // Handle selection
    window.toggleItem = function(index, checked) {
      if (checked) selectedItems.push(inventoryData[index]);
      else selectedItems = selectedItems.filter(i => i !== inventoryData[index]);
    };

    window.openModal = function() { document.getElementById("modal").style.display = "block"; }
    window.closeModal = function() { document.getElementById("modal").style.display = "none"; }

    // üîπ PDF Generator
    window.generatePDF = async function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();

      // Load logo once
      if (!logoBase64) {
        logoBase64 = await loadLogo();
      }

      let y = 50;
      let pageNum = 1;

      const addHeader = () => {
        doc.setFontSize(18);
        doc.text(CONFIG.galleryName, pageWidth/2, 15, { align: "center" });
        doc.setFontSize(11);
        doc.text("Call " + CONFIG.phone + " to place an order", pageWidth/2, 22, { align: "center" });
        doc.text(CONFIG.address, pageWidth/2, 28, { align: "center" });
        if (logoBase64) {
          doc.addImage(logoBase64, "PNG", 10, 5, 20, 20);
        }
        doc.line(10, 34, pageWidth-10, 34);
      };

      const addFooter = () => {
        doc.setFontSize(9);
        doc.line(10, 280, pageWidth-10, 280);
        doc.text(CONFIG.footerNote, pageWidth/2, 286, { align: "center" });
        doc.text(CONFIG.address, pageWidth/2, 292, { align: "center" });
        doc.text("Page " + pageNum, pageWidth-20, 295);
      };

      addHeader();
      doc.setFontSize(12);
      doc.text("Client: " + document.getElementById("clientName").value, 14, y); y+=8;
      doc.text("Notes: " + document.getElementById("clientNotes").value, 14, y); y+=12;

      selectedItems.forEach((item, i) => {
        doc.setFontSize(14);
        doc.text(`${item.brand || ""} ${item.model || ""}`, 14, y); y+=7;
        doc.setFontSize(11);
        if (item.year) doc.text(`Year: ${item.year}`, 14, y), y+=6;
        if (item.serial) doc.text(`Serial: ${item.serial}`, 14, y), y+=6;
        if (item.color) doc.text(`Color: ${item.color}`, 14, y), y+=6;
        if (item.length) doc.text(`Length: ${item.length}`, 14, y), y+=6;
        if (item.price) doc.text(`Price: ${item.price}`, 14, y), y+=6;

        if (item.photo) {
          doc.setTextColor(0,0,255);
          doc.textWithLink("View Photo", 14, y, { url: item.photo });
          doc.setTextColor(0,0,0);
          y+=10;
        } else { y+=6; }

        y+=4;
        if (y>250 && i < selectedItems.length-1) {
          addFooter();
          doc.addPage();
          pageNum++;
          y=50;
          addHeader();
        }
      });

      addFooter();
      doc.save("piano-brochure.pdf");
      closeModal();
    };

    // Load everything
    loadLogo();
    loadInventory();
  </script>
</body>
</html>
