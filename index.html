<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Brochure Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f4f4f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 25px;
    }
    header img {
      height: 90px;
      display: block;
      margin: 0 auto 10px;
    }
    h1 {
      margin: 0;
      font-size: 30px;
      color: #222;
    }
    .btn {
      background: #0069d9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: background 0.2s;
    }
    .btn:hover { background: #0053a6; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ececec;
    }
    th {
      background: #0069d9;
      color: white;
      text-transform: uppercase;
      font-size: 14px;
    }
    tr:hover td { background: #eef5ff; }
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #modalContent {
      background: #fff;
      margin: 5% auto;
      padding: 25px;
      width: 420px;
      border-radius: 8px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    }
    input, textarea {
      width: 100%;
      margin: 8px 0 15px;
      padding: 8px;
      border: 1px solid #bbb;
      border-radius: 5px;
    }
    label { font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" id="siteLogo">
    <h1 id="siteName">World Class Piano Gallery</h1>
    <p id="sitePhone">(555) 123-4567</p>
    <p id="siteAddress">123 Main Street, Dawsonville, GA</p>
  </header>

  <button class="btn" onclick="openModal()">Create Brochure</button>
  <div id="inventory">Loading inventory...</div>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h3>Create Brochure</h3>

      <label>Gallery Name:</label>
      <input type="text" id="galleryName" placeholder="World Class Piano Gallery">

      <label>Phone:</label>
      <input type="text" id="contactPhone" placeholder="(555) 123-4567">

      <label>Address:</label>
      <input type="text" id="contactAddress" placeholder="123 Main Street, Dawsonville, GA">

      <label>Footer Note:</label>
      <input type="text" id="footerNote" placeholder="Delivery FREE within 1000 miles • Complimentary tuning included">

      <label>Client Name:</label>
      <input type="text" id="clientName">

      <label>Notes:</label>
      <textarea id="clientNotes" rows="4"></textarea>

      <button class="btn" onclick="updateContactInfo(); generatePDF();">Generate PDF</button>
      <button class="btn" style="background:#6c757d" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let inventoryData = [];
    let selectedItems = [];
    let logoBase64 = null;

    async function loadLogo() {
      try {
        const resp = await fetch("logo.png");
        const blob = await resp.blob();
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (err) {
        console.warn("Logo load failed:", err);
        return null;
      }
    }

    async function loadInventory() {
      try {
        const snap = await getDocs(collection(db, "pianos"));
        inventoryData = snap.docs.map(d => d.data());
        renderTable();
      } catch (err) {
        document.getElementById("inventory").innerHTML =
          "<p>❌ Could not load inventory. Check Firestore rules.</p>";
        console.error("Firestore error:", err);
      }
    }

    function renderTable() {
      const container = document.getElementById("inventory");
      if (inventoryData.length === 0) {
        container.innerHTML = "<p>No listings found.</p>";
        return;
      }
      let html = `<table><tr>
        <th>Select</th><th>Brand</th><th>Year</th><th>Model</th>
        <th>Length</th><th>Color</th><th>Cost</th><th>Photo</th>
      </tr>`;
      inventoryData.forEach((item, i) => {
        html += `<tr>
          <td><input type="checkbox" onchange="toggleItem(${i}, this.checked)"></td>
          <td>${item.brand || ""}</td>
          <td>${item.year || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.length || ""}</td>
          <td>${item.color || ""}</td>
          <td>${item.price || ""}</td>
          <td>${ item.photo ? `<a href="${item.photo}" target="_blank">View</a>` : "" }</td>
        </tr>`;
      });
      html += `</table>`;
      container.innerHTML = html;
    }

    window.updateContactInfo = function() {
      const galleryName = document.getElementById("galleryName").value || "World Class Piano Gallery";
      const contactPhone = document.getElementById("contactPhone").value || "(555) 123-4567";
      const contactAddress = document.getElementById("contactAddress").value || "123 Main Street, Dawsonville, GA";

      document.getElementById("siteName").innerText = galleryName;
      document.getElementById("sitePhone").innerText = contactPhone;
      document.getElementById("siteAddress").innerText = contactAddress;
    };

    window.toggleItem = function(i, checked) {
      if (checked) selectedItems.push(inventoryData[i]);
      else selectedItems = selectedItems.filter(x => x !== inventoryData[i]);
    };

    window.openModal = () => { document.getElementById("modal").style.display = "block"; };
    window.closeModal = () => { document.getElementById("modal").style.display = "none"; };

    window.generatePDF = async function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      if (!logoBase64) logoBase64 = await loadLogo();

      const galleryName = document.getElementById("siteName").innerText;
      const contactPhone = document.getElementById("sitePhone").innerText;
      const contactAddress = document.getElementById("siteAddress").innerText;
      const footerNote = document.getElementById("footerNote").value || "Delivery FREE within 1000 miles • Complimentary tuning included";

      const clientName = document.getElementById("clientName").value;
      const clientNotes = document.getElementById("clientNotes").value;
      const today = new Date().toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });

      // Cover page
      if (logoBase64) {
        const imgW = 50;
        const imgH = 35;
        const imgX = (pageWidth - imgW) / 2;
        doc.addImage(logoBase64, "PNG", imgX, 20, imgW, imgH);
      }
      doc.setFontSize(28);
      doc.setFont("helvetica", "bold");
      doc.text(galleryName, pageWidth/2, 95, { align: "center" });

      doc.setFontSize(14);
      doc.setFont("helvetica", "normal");
      doc.text(contactAddress, pageWidth/2, 110, { align: "center" });
      doc.text("Call " + contactPhone, pageWidth/2, 118, { align: "center" });

      doc.setFontSize(12);
      doc.text("Exclusive Pianos • Fine Craftsmanship • Professional Service", pageWidth/2, 128, { align: "center" });
      doc.addPage();

      let y = 35;
      let pageNum = 2;

      const addHeader = () => {
        if (logoBase64) {
          const imgW = 30;
          const imgH = 20;
          const imgX = (pageWidth - imgW) / 2;
          doc.addImage(logoBase64, "PNG", imgX, 5, imgW, imgH);
        }
        if (logoBase64) {
          const wmWidth = pageWidth * 0.6;
          const wmHeight = wmWidth * 0.4;
          const wmX = (pageWidth - wmWidth) / 2;
          const wmY = (pageHeight - wmHeight) / 2;
          doc.addImage(logoBase64, "PNG", wmX, wmY, wmWidth, wmHeight, "", "FAST", 0.1);
        }
        doc.setFontSize(16);
        doc.text(galleryName, pageWidth/2, 20, { align: "center" });
        doc.setFontSize(10);
        doc.text(contactAddress, pageWidth/2, 26, { align: "center" });
        doc.text("Call " + contactPhone, pageWidth/2, 32, { align: "center" });
        doc.line(15, 35, pageWidth-15, 35);
        y = 42;
      };

      const addFooter = () => {
        doc.setFontSize(9);
        doc.line(15, 280, pageWidth-15, 280);
        doc.setFont("helvetica", "bold");
        doc.text(footerNote, pageWidth/2, 286, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.text(contactAddress, pageWidth/2, 292, { align: "center" });
        doc.text("Page " + pageNum, pageWidth-20, 295);
      };

      addHeader();

      // Client info + date
      if (clientName || clientNotes) {
        doc.setFontSize(14);
        doc.text("Prepared for:", 20, y);
        doc.setFontSize(12);
        if (clientName) {
          doc.text(clientName, 20, y + 8);
          y += 10;
        }
        if (clientNotes) {
          const splitNotes = doc.splitTextToSize(clientNotes, pageWidth - 40);
          doc.text(splitNotes, 20, y + 8);
          y += (splitNotes.length * 6) + 12;
        }
        doc.setFontSize(11);
        doc.text("Prepared on: " + today, 20, y + 8);
        y += 20;
      }

      // Listings
      for (let i = 0; i < selectedItems.length; i++) {
        const item = selectedItems[i];
        if (item.photo) {
          try {
            const resp = await fetch(item.photo);
            const blob = await resp.blob();
            const reader = new FileReader();
            const imgData = await new Promise((res) => {
              reader.onload = () => res(reader.result);
              reader.readAsDataURL(blob);
            });
            const imgW = 40, imgH = 28;
            doc.addImage(imgData, "PNG", 15, y, imgW, imgH);
          } catch (err) {
            console.warn("Could not embed photo:", err);
          }
        }
        const xText = 60;
        doc.setFontSize(12);
        doc.text(`${item.brand || ""} ${item.model || ""} (${item.year || ""})`, xText, y + 5);
        doc.setFontSize(10);
        doc.text(`Length: ${item.length || ""}`, xText, y + 12);
        doc.text(`Color: ${item.color || ""}`, xText, y + 18);
        doc.setFont("helvetica", "bold");
        doc.text(`Cost: ${item.price || "Call for Pricing"}`, xText, y + 24);
        doc.setFont("helvetica", "normal");

        y += 40;
        if (y > 240 && i < selectedItems.length - 1) {
          addFooter();
          doc.addPage();
          pageNum++;
          addHeader();
        }
      }

      addFooter();

      // ✅ filename with client name
      let filename = "piano-brochure";
      if (clientName) {
        filename += "-" + clientName.replace(/\s+/g, "");
      }
      doc.save(filename + ".pdf");

      window.closeModal();
    };

    loadLogo();
    loadInventory();
  </script>
</body>
</html>
