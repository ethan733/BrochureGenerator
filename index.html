<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Brochure Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f4f4f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 25px;
    }
    header img {
      height: 90px;
      display: block;
      margin: 0 auto 10px;
    }
    h1 {
      margin: 0;
      font-size: 30px;
      color: #222;
    }
    .btn {
      background: #0069d9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 15px 0;
      transition: background 0.2s;
    }
    .btn:hover { background: #0053a6; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ececec;
    }
    th {
      background: #0069d9;
      color: white;
      text-transform: uppercase;
      font-size: 14px;
    }
    tr:hover td {
      background: #eef5ff;
    }
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #modalContent {
      background: #fff;
      margin: 10% auto;
      padding: 25px;
      width: 380px;
      border-radius: 8px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    }
    input, textarea {
      width: 100%;
      margin: 8px 0 20px;
      padding: 8px;
      border: 1px solid #bbb;
      border-radius: 5px;
    }
    a { color: #0069d9; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" id="siteLogo">
    <h1 id="siteName"></h1>
    <p id="sitePhone"></p>
    <p id="siteAddress"></p>
  </header>

  <button class="btn" onclick="openModal()">Create Brochure</button>
  <div id="inventory">Loading inventory...</div>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h3>Create Brochure</h3>
      <label>Client Name:</label>
      <input type="text" id="clientName">
      <label>Notes:</label>
      <textarea id="clientNotes" rows="4"></textarea>
      <button class="btn" onclick="generatePDF()">Generate PDF</button>
      <button class="btn" style="background:#6c757d" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ‚úÖ CONFIG
    const CONFIG = {
      galleryName: "World Class Piano Gallery",
      phone: "(555) 123-4567",
      address: "123 Main Street, Dawsonville, GA",
      footerNote: "Delivery FREE within 1000 miles ‚Ä¢ Complimentary tuning included",
      logoPath: "logo.png"
    };

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let inventoryData = [];
    let selectedItems = [];
    let logoBase64 = null;

    // Header text
    document.getElementById("siteName").innerText = CONFIG.galleryName;
    document.getElementById("sitePhone").innerText = "Call " + CONFIG.phone + " to order";
    document.getElementById("siteAddress").innerText = CONFIG.address;

    // Convert logo
    async function loadLogo() {
      try {
        const resp = await fetch(CONFIG.logoPath);
        const blob = await resp.blob();
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch (err) {
        console.warn("Logo load failed:", err);
        return null;
      }
    }

    // Load inventory
    async function loadInventory() {
      try {
        const snap = await getDocs(collection(db, "pianos"));
        inventoryData = snap.docs.map(d => d.data());
        renderTable();
      } catch (err) {
        document.getElementById("inventory").innerHTML =
          "<p>‚ùå Could not load inventory. Check Firestore rules.</p>";
        console.error("Firestore error:", err);
      }
    }

    function renderTable() {
      const container = document.getElementById("inventory");
      if (inventoryData.length === 0) {
        container.innerHTML = "<p>No listings found.</p>";
        return;
      }
      let html = `<table><tr>
        <th>Select</th><th>Brand</th><th>Year</th><th>Model</th>
        <th>Length</th><th>Color</th><th>Cost</th><th>Photo</th>
      </tr>`;
      inventoryData.forEach((item, i) => {
        html += `<tr>
          <td><input type="checkbox" onchange="toggleItem(${i}, this.checked)"></td>
          <td>${item.brand || ""}</td>
          <td>${item.year || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.length || ""}</td>
          <td>${item.color || ""}</td>
          <td>${item.price || ""}</td>
          <td>${ item.photo ? `<a href="${item.photo}" target="_blank">View</a>` : "" }</td>
        </tr>`;
      });
      html += `</table>`;
      container.innerHTML = html;
    }

    // üîπ Expose globals
    window.toggleItem = function(i, checked) {
      if (checked) selectedItems.push(inventoryData[i]);
      else selectedItems = selectedItems.filter(x => x !== inventoryData[i]);
    };

    window.openModal = () => { document.getElementById("modal").style.display = "block"; };
    window.closeModal = () => { document.getElementById("modal").style.display = "none"; };

    window.generatePDF = async function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();

      if (!logoBase64) logoBase64 = await loadLogo();

      // Cover page
      if (logoBase64) {
        const imgW = 60;
        const imgX = (pageWidth - imgW) / 2;
        doc.addImage(logoBase64, "PNG", imgX, 20, imgW, imgW * 0.5);
      }
      doc.setFontSize(24);
      doc.text(CONFIG.galleryName, pageWidth/2, 90, { align: "center" });
      doc.setFontSize(14);
      doc.text(CONFIG.address, pageWidth/2, 105, { align: "center" });
      doc.text("Call " + CONFIG.phone, pageWidth/2, 115, { align: "center" });
      doc.addPage();

      let y = 35;
      let pageNum = 2;

      const addHeader = () => {
        if (logoBase64) {
          const imgW = 30;
          const imgX = (pageWidth - imgW) / 2;
          doc.addImage(logoBase64, "PNG", imgX, 5, imgW, imgW * 0.5);
        }
        doc.setFontSize(16);
        doc.text(CONFIG.galleryName, pageWidth/2, 20, { align: "center" });
        doc.setFontSize(10);
        doc.text(CONFIG.address, pageWidth/2, 26, { align: "center" });
        doc.text("Call " + CONFIG.phone, pageWidth/2, 32, { align: "center" });
        doc.line(15, 35, pageWidth-15, 35);
        y = 42;
      };

      const addFooter = () => {
        doc.setFontSize(9);
        doc.line(15, 280, pageWidth-15, 280);
        doc.text(CONFIG.footerNote, pageWidth/2, 286, { align: "center" });
        doc.text(CONFIG.address, pageWidth/2, 292, { align: "center" });
        doc.text("Page " + pageNum, pageWidth-20, 295);
      };

      addHeader();

      for (let i = 0; i < selectedItems.length; i++) {
        const item = selectedItems[i];

        // Image
        if (item.photo) {
          try {
            const resp = await fetch(item.photo);
            const blob = await resp.blob();
            const reader = new FileReader();
            const imgData = await new Promise((res) => {
              reader.onload = () => res(reader.result);
              reader.readAsDataURL(blob);
            });
            const imgW = 40, imgH = 28;
            doc.addImage(imgData, "PNG", 15, y, imgW, imgH);
          } catch (err) {
            console.warn("Could not embed photo:", err);
          }
        }

        // Text fields
        const xText = 60;
        doc.setFontSize(12);
        doc.text(`${item.brand || ""} ${item.model || ""} (${item.year || ""})`, xText, y + 5);
        doc.setFontSize(10);
        doc.text(`Length: ${item.length || ""}`, xText, y + 12);
        doc.text(`Color: ${item.color || ""}`, xText, y + 18);
        doc.text(`Cost: ${item.price || ""}`, xText, y + 24);

        y += 40;
        if (y > 240 && i < selectedItems.length - 1) {
          addFooter();
          doc.addPage();
          pageNum++;
          addHeader();
        }
      }

      addFooter();
      doc.save("piano-brochure.pdf");
      window.closeModal();
    };

    loadLogo();
    loadInventory();
  </script>
</body>
</html>
