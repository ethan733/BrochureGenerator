<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Piano Brochure Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- jsPDF UMD -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --brand: #0069d9;
      --bg: #f4f4f8;
      --text: #333;
      --card: #fff;
      --muted: #6c757d;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0; padding: 20px;
    }
    header { text-align: center; margin-bottom: 20px; }
    header img { height: 90px; display: block; margin: 0 auto 10px; object-fit: contain; }
    h1 { margin: 0; font-size: 30px; color: #222; }
    .btn {
      background: var(--brand); color: #fff; border: none; border-radius: 6px;
      padding: 12px 18px; font-size: 16px; cursor: pointer; margin: 10px 5px;
      transition: background 0.2s;
    }
    .btn:hover { background: #0053a6; }
    .btn-muted { background: var(--muted); }
    #mainArea { display: flex; gap: 20px; flex-wrap: wrap; }
    #inventory { flex: 2 1 580px; }
    #preview {
      flex: 1 1 340px; background: var(--card); border: 1px solid #ccc;
      border-radius: 10px; padding: 15px; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    #preview h2 { text-align: center; margin: 0 0 10px; }
    #previewLogo {
      display: block; margin: 0 auto 10px; width: 80px; height: 80px; object-fit: contain;
    }
    table {
      width: 100%; border-collapse: collapse; background: var(--card);
      border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: var(--brand); color: #fff; text-transform: uppercase; font-size: 13px; }
    tr:hover td { background: #eef5ff; }
    .preview-item {
      border: 1px solid #e6e6e6; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fafafa;
    }
    /* Modal */
    #modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 1000; padding: 20px;
    }
    #modalContent {
      background: #fff; margin: 0 auto; width: min(560px, 92vw);
      max-height: 90vh; border-radius: 10px; box-shadow: 0 12px 28px rgba(0,0,0,0.25);
      display: flex; flex-direction: column; overflow: hidden;
    }
    #modalBody {
      padding: 20px; overflow-y: auto; flex: 1 1 auto;
    }
    .modal-actions {
      padding: 12px 16px; border-top: 1px solid #eee; background: #fff; position: sticky; bottom: 0;
      display: flex; gap: 10px; justify-content: flex-end;
    }
    label { font-weight: 600; display: block; margin-top: 10px; }
    input, textarea {
      width: 100%; margin-top: 6px; padding: 10px; border: 1px solid #bbb; border-radius: 6px;
      font-size: 14px;
    }
    .help { color: #666; font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" id="siteLogo" />
    <h1 id="siteName">World Class Piano Gallery</h1>
    <p id="sitePhone">404 491 1656</p>
    <p id="siteAddress">1000 North Point Cir, Alpharetta, Georgia, 30022</p>
  </header>

  <button class="btn" onclick="openModal()">Create Brochure</button>

  <div id="mainArea">
    <!-- Inventory Table -->
    <div id="inventory">Loading inventory...</div>

    <!-- Live Preview -->
    <div id="preview">
      <h2>üìÑ Brochure Preview</h2>
      <div id="previewContent"><!-- filled by JS --></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" role="dialog" aria-modal="true">
    <div id="modalContent">
      <div id="modalBody">
        <h3 style="margin:0 0 10px;">Create Brochure</h3>

        <label>Gallery Name</label>
        <input type="text" id="galleryName" value="World Class Piano Gallery" oninput="updateContactInfo(); updatePreview();" />

        <label>Phone</label>
        <input type="text" id="contactPhone" value="404 491 1656" oninput="updateContactInfo(); updatePreview();" />

        <label>Address</label>
        <input type="text" id="contactAddress" value="1000 North Point Cir, Alpharetta, Georgia, 30022" oninput="updateContactInfo(); updatePreview();" />

        <label>Cover Page Tagline</label>
        <input type="text" id="coverTagline" placeholder="Exclusive Pianos ‚Ä¢ Fine Craftsmanship ‚Ä¢ Professional Service" oninput="updatePreview();" />

        <label>Footer Note</label>
        <input type="text" id="footerNote" placeholder="Delivery FREE within 1000 miles ‚Ä¢ Complimentary tuning included" oninput="updatePreview();" />

        <label>Client Name</label>
        <input type="text" id="clientName" oninput="updatePreview();" />

        <label>Notes</label>
        <textarea id="clientNotes" rows="4" oninput="updatePreview();"></textarea>
        <p class="help">Tip: Your selections on the left appear in the preview and in the PDF.</p>
      </div>

      <div class="modal-actions">
        <button class="btn" onclick="generatePDF();">Generate PDF</button>
        <button class="btn btn-muted" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // State
    let inventoryData = [];
    let selectedItems = [];
    let logoBase64 = null;

    // Helpers
    async function getLogo() {
      if (logoBase64) return logoBase64;
      try {
        const resp = await fetch("logo.png", { cache: "reload" });
        const blob = await resp.blob();
        logoBase64 = await new Promise((resolve) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.readAsDataURL(blob);
        });
        return logoBase64;
      } catch (e) {
        console.warn("Logo load failed:", e);
        return null;
      }
    }

    // Inventory
    async function loadInventory() {
      try {
        console.log("Fetching inventory...");
        const snap = await getDocs(collection(db, "pianos"));
        console.log("Docs found:", snap.docs.length);
        inventoryData = snap.docs.map(d => d.data());
        renderTable();
        window.updatePreview();
      } catch (err) {
        console.error("Firestore error:", err);
        document.getElementById("inventory").innerHTML =
          "<p>‚ùå Could not load inventory. Check Firestore rules.</p>";
      }
    }

    function renderTable() {
      const el = document.getElementById("inventory");
      if (!inventoryData.length) {
        el.innerHTML = "<p>‚ùå No piano listings found in Firestore.</p>";
        return;
      }
      let html = `<table><tr>
        <th>Select</th><th>Brand</th><th>Year</th><th>Model</th>
        <th>Length</th><th>Color</th><th>Cost</th><th>Photo</th>
      </tr>`;
      inventoryData.forEach((item, i) => {
        html += `<tr>
          <td><input type="checkbox" onchange="toggleItem(${i}, this.checked)" /></td>
          <td>${item.brand ?? ""}</td>
          <td>${item.year ?? ""}</td>
          <td>${item.model ?? ""}</td>
          <td>${item.length ?? ""}</td>
          <td>${item.color ?? ""}</td>
          <td>${item.price ?? ""}</td>
          <td>${item.photo ? `<a href="${item.photo}" target="_blank">View</a>` : ""}</td>
        </tr>`;
      });
      html += `</table>`;
      el.innerHTML = html;
    }

    // üîì Expose to global for inline handlers:
    window.openModal = () => { document.getElementById("modal").style.display = "block"; };
    window.closeModal = () => { document.getElementById("modal").style.display = "none"; };

    window.updateContactInfo = function updateContactInfo() {
      const name = document.getElementById("galleryName").value || "World Class Piano Gallery";
      const phone = document.getElementById("contactPhone").value || "404 491 1656";
      const addr = document.getElementById("contactAddress").value || "1000 North Point Cir, Alpharetta, Georgia, 30022";
      document.getElementById("siteName").innerText = name;
      document.getElementById("sitePhone").innerText = phone;
      document.getElementById("siteAddress").innerText = addr;
    };

    window.toggleItem = function toggleItem(i, checked) {
      const item = inventoryData[i];
      if (checked) selectedItems.push(item);
      else selectedItems = selectedItems.filter(x => x !== item);
      window.updatePreview();
    };

    window.updatePreview = function updatePreview() {
      const galleryName = document.getElementById("siteName").innerText;
      const contactPhone = document.getElementById("sitePhone").innerText;
      const contactAddress = document.getElementById("siteAddress").innerText;
      const coverTagline = document.getElementById("coverTagline")?.value || "Exclusive Pianos ‚Ä¢ Fine Craftsmanship ‚Ä¢ Professional Service";
      const clientName = document.getElementById("clientName")?.value;
      const clientNotes = document.getElementById("clientNotes")?.value;

      let html = `
        <img id="previewLogo" src="logo.png" alt="Logo" />
        <h3 style="margin:0; text-align:center;">${galleryName}</h3>
        <p style="text-align:center;"><em>${coverTagline}</em></p>
        <p style="text-align:center;">${contactAddress}<br>Call: ${contactPhone}</p>
        <hr />
      `;

      if (clientName || clientNotes) {
        html += `<p><strong>Prepared for:</strong> ${clientName ?? ""}</p>`;
        if (clientNotes) html += `<p><em>${clientNotes}</em></p>`;
        html += `<hr />`;
      }

      if (!selectedItems.length) {
        html += "<p>No items selected yet.</p>";
      } else {
        selectedItems.forEach(item => {
          html += `
            <div class="preview-item">
              <strong>${item.brand ?? ""} ${item.model ?? ""} (${item.year ?? ""})</strong><br />
              Length: ${item.length ?? ""} &nbsp;|&nbsp; Color: ${item.color ?? ""}<br />
              <strong>Cost: ${item.price ?? "Call for Pricing"}</strong><br />
              ${item.photo ? `<a href="${item.photo}" target="_blank">View Photo</a>` : ""}
            </div>`;
        });
      }

      document.getElementById("previewContent").innerHTML = html;
    };

    window.generatePDF = async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const logo = await getLogo();
      const galleryName = document.getElementById("siteName").innerText;
      const contactPhone = document.getElementById("sitePhone").innerText;
      const contactAddress = document.getElementById("siteAddress").innerText;
      const coverTagline = document.getElementById("coverTagline").value || "Exclusive Pianos ‚Ä¢ Fine Craftsmanship ‚Ä¢ Professional Service";
      const footerNote = document.getElementById("footerNote").value || "Delivery FREE within 1000 miles ‚Ä¢ Complimentary tuning included";
      const clientName = document.getElementById("clientName").value;
      const clientNotes = document.getElementById("clientNotes").value;
      const today = new Date().toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });

      // Cover (square logo, centered)
      if (logo) {
        const size = 40; const x = (pageW - size) / 2;
        doc.addImage(logo, "PNG", x, 20, size, size);
      }
      doc.setFont("helvetica", "bold"); doc.setFontSize(28);
      doc.text(galleryName, pageW/2, 95, { align: "center" });
      doc.setFont("helvetica", "normal"); doc.setFontSize(14);
      doc.text(contactAddress, pageW/2, 110, { align: "center" });
      doc.text("Call " + contactPhone, pageW/2, 118, { align: "center" });
      doc.setFontSize(12);
      doc.text(coverTagline, pageW/2, 128, { align: "center" });
      doc.addPage();

      let y = 35; let pageNum = 2;

      const addHeader = () => {
        // small square logo
        if (logo) {
          const size = 20; const x = (pageW - size) / 2;
          doc.addImage(logo, "PNG", x, 5, size, size);
        }
        // square watermark (faint)
        if (logo) {
          const s = pageW * 0.5;
          const x = (pageW - s)/2, yWM = (pageH - s)/2;
          doc.addImage(logo, "PNG", x, yWM, s, s, "", "FAST", 0.08);
        }
        doc.setFont("helvetica", "normal");
        doc.setFontSize(16);
        doc.text(galleryName, pageW/2, 20, { align: "center" });
        doc.setFontSize(10);
        doc.text(contactAddress, pageW/2, 26, { align: "center" });
        doc.text("Call " + contactPhone, pageW/2, 32, { align: "center" });
        doc.line(15, 35, pageW - 15, 35);
        y = 42;
      };

      const addFooter = () => {
        doc.setFontSize(9);
        doc.line(15, 280, pageW - 15, 280);
        doc.setFont("helvetica", "bold");
        doc.text(footerNote, pageW/2, 286, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.text(contactAddress, pageW/2, 292, { align: "center" });
        doc.text("Page " + pageNum, pageW - 20, 295);
      };

      addHeader();

      // Client section + date
      if (clientName || clientNotes) {
        doc.setFontSize(14);
        doc.text("Prepared for:", 20, y);
        doc.setFontSize(12);
        if (clientName) { doc.text(clientName, 20, y + 8); y += 10; }
        if (clientNotes) {
          const lines = doc.splitTextToSize(clientNotes, pageW - 40);
          doc.text(lines, 20, y + 8);
          y += lines.length * 6 + 12;
        }
        doc.setFontSize(11);
        doc.text("Prepared on: " + today, 20, y + 8);
        y += 20;
      }

      // Listings
      for (let i = 0; i < selectedItems.length; i++) {
        const item = selectedItems[i];

        // photo square thumb (if available)
        if (item.photo) {
          try {
            const resp = await fetch(item.photo, { cache: "no-cache" });
            const blob = await resp.blob();
            const img64 = await new Promise((resolve) => {
              const r = new FileReader(); r.onload = () => resolve(r.result); r.readAsDataURL(blob);
            });
            const size = 28; // square
            doc.addImage(img64, "PNG", 15, y, size, size);
          } catch (e) {
            console.warn("Photo embed failed:", e);
          }
        }

        const xText = 50;
        doc.setFont("helvetica", "normal"); doc.setFontSize(12);
        doc.text(`${item.brand ?? ""} ${item.model ?? ""} (${item.year ?? ""})`, xText, y + 5);
        doc.setFontSize(10);
        doc.text(`Length: ${item.length ?? ""}`, xText, y + 12);
        doc.text(`Color: ${item.color ?? ""}`, xText, y + 18);
        doc.setFont("helvetica", "bold");
        doc.text(`Cost: ${item.price ?? "Call for Pricing"}`, xText, y + 24);
        doc.setFont("helvetica", "normal");

        y += 40;
        if (y > 240 && i < selectedItems.length - 1) {
          addFooter(); doc.addPage(); pageNum++; addHeader();
        }
      }

      addFooter();

      let filename = "piano-brochure";
      if (clientName) filename += "-" + clientName.replace(/\s+/g, "");
      doc.save(filename + ".pdf");

      window.closeModal();
    };

    // Kick things off
    loadInventory();
    // Initialize preview on first load (defaults)
    window.updatePreview();
  </script>
</body>
</html>
