<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Piano Brochure Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: "Segoe UI", Tahoma, sans-serif; background: #f4f4f8; margin: 0; padding: 20px; color: #333; }
    header { text-align: center; margin-bottom: 25px; }
    header img { height: 90px; display: block; margin: 0 auto 10px; }
    h1 { margin: 0; font-size: 30px; color: #222; }
    .btn { background: #0069d9; color: white; border: none; border-radius: 5px; padding: 12px 20px; font-size: 16px; cursor: pointer; margin: 10px 5px; transition: background 0.2s; }
    .btn:hover { background: #0053a6; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ececec; }
    th { background: #0069d9; color: white; text-transform: uppercase; font-size: 14px; }
    tr:hover td { background: #eef5ff; }
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    #modalContent { background: #fff; margin: 5% auto; padding: 25px; width: 420px; border-radius: 8px; box-shadow: 0 4px 14px rgba(0,0,0,0.25); }
    input, textarea { width: 100%; margin: 8px 0 15px; padding: 8px; border: 1px solid #bbb; border-radius: 5px; }
    label { font-weight: bold; }
    #mainArea { display: flex; gap: 20px; }
    #preview { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 15px; overflow-y: auto; max-height: 80vh; }
    #inventory { flex: 2; }
    #preview h2 { text-align: center; margin-top: 0; }
    #previewLogo { display: block; margin: 0 auto 10px; width: 80px; height: 80px; object-fit: contain; }
    .preview-item { border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: #fafafa; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo" id="siteLogo">
    <h1 id="siteName">World Class Piano Gallery</h1>
    <p id="sitePhone">404 491 1656</p>
    <p id="siteAddress">1000 North Point Cir, Alpharetta, Georgia, 30022</p>
  </header>

  <button class="btn" onclick="openModal()">Create Brochure</button>

  <div id="mainArea">
    <!-- Inventory Table -->
    <div id="inventory">Loading inventory...</div>

    <!-- Live Preview -->
    <div id="preview">
      <h2>üìÑ Brochure Preview</h2>
      <div id="previewContent"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h3>Create Brochure</h3>
      <label>Gallery Name:</label>
      <input type="text" id="galleryName" value="World Class Piano Gallery" oninput="updateContactInfo(); updatePreview();">
      <label>Phone:</label>
      <input type="text" id="contactPhone" value="404 491 1656" oninput="updateContactInfo(); updatePreview();">
      <label>Address:</label>
      <input type="text" id="contactAddress" value="1000 North Point Cir, Alpharetta, Georgia, 30022" oninput="updateContactInfo(); updatePreview();">
      <label>Cover Page Tagline:</label>
      <input type="text" id="coverTagline" placeholder="Exclusive Pianos ‚Ä¢ Fine Craftsmanship ‚Ä¢ Professional Service" oninput="updatePreview();">
      <label>Footer Note:</label>
      <input type="text" id="footerNote" placeholder="Delivery FREE within 1000 miles ‚Ä¢ Complimentary tuning included" oninput="updatePreview();">
      <label>Client Name:</label>
      <input type="text" id="clientName" oninput="updatePreview();">
      <label>Notes:</label>
      <textarea id="clientNotes" rows="4" oninput="updatePreview();"></textarea>
      <button class="btn" onclick="generatePDF();">Generate PDF</button>
      <button class="btn" style="background:#6c757d" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.appspot.com",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let inventoryData = [];
    let selectedItems = [];

    async function loadInventory() {
      try {
        console.log("Fetching inventory...");
        const snap = await getDocs(collection(db, "pianos"));
        console.log("Docs found:", snap.docs.length);

        inventoryData = snap.docs.map(d => d.data());
        console.log("Inventory Data:", inventoryData);

        renderTable();
        updatePreview();
      } catch (err) {
        document.getElementById("inventory").innerHTML =
          "<p>‚ùå Could not load inventory. Check Firestore rules.</p>";
        console.error("Firestore error:", err);
      }
    }

    function renderTable() {
      const container = document.getElementById("inventory");
      if (inventoryData.length === 0) {
        container.innerHTML = "<p>‚ùå No piano listings found in Firestore.</p>";
        return;
      }
      let html = `<table><tr>
        <th>Select</th><th>Brand</th><th>Year</th><th>Model</th>
        <th>Length</th><th>Color</th><th>Cost</th><th>Photo</th>
      </tr>`;
      inventoryData.forEach((item, i) => {
        html += `<tr>
          <td><input type="checkbox" onchange="toggleItem(${i}, this.checked)"></td>
          <td>${item.brand || ""}</td>
          <td>${item.year || ""}</td>
          <td>${item.model || ""}</td>
          <td>${item.length || ""}</td>
          <td>${item.color || ""}</td>
          <td>${item.price || ""}</td>
          <td>${ item.photo ? `<a href="${item.photo}" target="_blank">View</a>` : "" }</td>
        </tr>`;
      });
      html += `</table>`;
      container.innerHTML = html;
    }

    window.updateContactInfo = function() {
      document.getElementById("siteName").innerText = document.getElementById("galleryName").value || "World Class Piano Gallery";
      document.getElementById("sitePhone").innerText = document.getElementById("contactPhone").value || "404 491 1656";
      document.getElementById("siteAddress").innerText = document.getElementById("contactAddress").value || "1000 North Point Cir, Alpharetta, Georgia, 30022";
    };

    window.toggleItem = function(i, checked) {
      if (checked) selectedItems.push(inventoryData[i]);
      else selectedItems = selectedItems.filter(x => x !== inventoryData[i]);
      updatePreview();
    };

    function updatePreview() {
      const galleryName = document.getElementById("siteName").innerText;
      const contactPhone = document.getElementById("sitePhone").innerText;
      const contactAddress = document.getElementById("siteAddress").innerText;
      const coverTagline = document.getElementById("coverTagline")?.value || "Exclusive Pianos ‚Ä¢ Fine Craftsmanship ‚Ä¢ Professional Service";
      const clientName = document.getElementById("clientName")?.value;
      const clientNotes = document.getElementById("clientNotes")?.value;

      let html = `
        <img id="previewLogo" src="logo.png" alt="Logo">
        <h3 style="margin:0; text-align:center;">${galleryName}</h3>
        <p style="text-align:center;"><em>${coverTagline}</em></p>
        <p style="text-align:center;">${contactAddress}<br>Call: ${contactPhone}</p>
        <hr>
      `;

      if (clientName || clientNotes) {
        html += `<p><strong>Prepared for:</strong> ${clientName || ""}</p>`;
        if (clientNotes) html += `<p><em>${clientNotes}</em></p>`;
        html += `<hr>`;
      }

      if (selectedItems.length === 0) {
        html += "<p>No items selected yet.</p>";
      } else {
        selectedItems.forEach(item => {
          html += `
            <div class="preview-item">
              <strong>${item.brand || ""} ${item.model || ""} (${item.year || ""})</strong><br>
              Length: ${item.length || ""} | Color: ${item.color || ""}<br>
              <strong>Cost: ${item.price || "Call for Pricing"}</strong><br>
              ${item.photo ? `<a href="${item.photo}" target="_blank">View Photo</a>` : ""}
            </div>`;
        });
      }

      document.getElementById("previewContent").innerHTML = html;
    }

    window.openModal = () => { document.getElementById("modal").style.display = "block"; };
    window.closeModal = () => { document.getElementById("modal").style.display = "none"; };

    loadInventory();
  </script>
</body>
</html>
